<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini CRM - Modern Business Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .modal-bg {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-box {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .stat-card {
            border-left: 4px solid;
        }
        .kanban-column {
            flex: 1 0 280px;
        }
        /* Custom scrollbar for Kanban board */
        .kanban-board::-webkit-scrollbar {
            height: 8px;
        }
        .kanban-board::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        .kanban-board::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-600 */
            border-radius: 4px;
        }
        .kanban-board::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-500 */
        }
    </style>
    <script>
        // Global handlers for Google API script loading.
        // They delegate to functions defined within our main script module.
        // This is necessary because the `onload` attribute in a script tag
        // executes in the global scope.
        function gapiLoaded() {
            window.onGapiLoaded?.();
        }
        function gisLoaded() {
            window.onGisLoaded?.();
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div id="app-container" class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-gray-800 text-gray-100 w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 sidebar">
            <a href="#" class="text-white flex items-center space-x-2 px-4">
                <i class="fas fa-rocket text-2xl"></i>
                <span class="text-2xl font-extrabold">Gemini CRM</span>
            </a>
            <nav>
                <a href="#dashboard" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-600 hover:text-white bg-blue-600">
                    <i class="fas fa-tachometer-alt w-6"></i> Dashboard
                </a>
                <a href="#contacts" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-600 hover:text-white">
                    <i class="fas fa-users w-6"></i> Contacts
                </a>
                <a href="#deals" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-600 hover:text-white">
                    <i class="fas fa-handshake w-6"></i> Deals
                </a>
                <a href="#tasks" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-blue-600 hover:text-white">
                    <i class="fas fa-tasks w-6"></i> Tasks
                </a>
            </nav>
            <div class="absolute bottom-4 px-4 w-full left-0">
                 <div id="google-auth-status" class="text-xs"></div>
                <p class="text-xs text-gray-400 mt-2">User ID:</p>
                <p id="userIdDisplay" class="text-xs text-gray-300 break-all"></p>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden main-content">
            <header class="flex justify-between items-center p-4 bg-gray-800 border-b border-gray-700">
                <div class="flex items-center">
                    <button id="menu-button" class="text-gray-200 focus:outline-none md:hidden">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h1 id="view-title" class="text-xl font-semibold ml-4">Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                     <button id="add-new-button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">
                        <i class="fas fa-plus mr-2"></i><span>Add Contact</span>
                    </button>
                    <button id="google-signin-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300 shadow-lg">
                        <i class="fab fa-google mr-2"></i><span>Sign in with Google</span>
                    </button>
                </div>
            </header>
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-900 p-4 md:p-6 lg:p-8">
                <!-- Views -->
                <div id="dashboard-view" class="view"></div>
                <div id="contacts-view" class="view hidden"></div>
                <div id="deals-view" class="view hidden"></div>
                <div id="tasks-view" class="view hidden"></div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 hidden modal-bg opacity-0">
        <div id="modal-box" class="bg-gray-800 rounded-xl shadow-2xl w-11/12 md:w-1/2 lg:w-1/3 p-8 transform scale-95 opacity-0 modal-box">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-white"></h2>
                <button id="modal-close-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="modal-content"></div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDocs, onSnapshot, updateDoc, deleteDoc, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gemini-crm-default';
        
        // Firebase Configuration - Provided by user
        const firebaseConfig = {
          apiKey: "AIzaSyAbevSvSzMp_7YTAV1Ue5EmOv57lzMUwJs",
          authDomain: "think-makeithappen.firebaseapp.com",
          projectId: "think-makeithappen",
          storageBucket: "think-makeithappen.appspot.com",
          messagingSenderId: "1097376661701",
          appId: "1:1097376661701:web:04c0d362617c94bc94f0ac"
        };

        // --- Google API Configuration ---
        // ###################################################################################
        // # IMPORTANT: You must replace these placeholder values with your own credentials  #
        // # from the Google Cloud Console for the Google integration to work.               #
        // ###################################################################################
        const GOOGLE_API_KEY = 'AIzaSyBxsJRIQVQMnMswwy5WcxlX2DZzupTL3-M'; 
        const GOOGLE_CLIENT_ID = '1097376661701-fn5nrsechri1l1tob6l2064ma6l27ck2.apps.googleusercontent.com';
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/contacts.readonly';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let googleIntegrationEnabled = false;


        // --- Global State ---
        let db, auth, userId;
        let contacts = [], deals = [], tasks = [];
        let currentView = 'dashboard';
        let currentEditingId = null;
        
        const dealStages = ['Qualification', 'Needs Analysis', 'Proposal', 'Negotiation', 'Closed Won', 'Closed Lost'];

        // --- DOM Elements ---
        const viewTitle = document.getElementById('view-title');
        const addNewButton = document.getElementById('add-new-button');
        const modal = document.getElementById('modal');
        const modalBox = document.getElementById('modal-box');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const googleAuthStatus = document.getElementById('google-auth-status');

        // --- Initialization ---
        async function initialize() {
            // Check for Google API keys and enable/disable integration accordingly.
            if (GOOGLE_API_KEY !== 'YOUR_GOOGLE_API_KEY' && GOOGLE_CLIENT_ID !== 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com') {
                googleIntegrationEnabled = true;
            } else {
                console.warn("Google API keys are missing. Google Contact import will be disabled. Please update GOOGLE_API_KEY and GOOGLE_CLIENT_ID in the script.");
            }

            // Firebase is essential. Stop if it's not configured.
            if (!firebaseConfig || !firebaseConfig.apiKey) {
                document.body.innerHTML = `<div class="bg-red-800 text-white p-8 text-center h-screen flex items-center justify-center"><p><strong>Firebase Configuration is missing.</strong><br>The application cannot start without it.</p></div>`;
                console.error("Firebase config is missing.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        await setupRealtimeListeners();
                        initializeAppUI();
                    } else {
                        try {
                            // In a standalone app, you might want to implement a full auth flow.
                            // For simplicity, we'll continue with anonymous sign-in.
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Anonymous sign-in failed:", error);
                            if (error.code === 'auth/configuration-not-found') {
                                document.body.innerHTML = `<div class="bg-red-800 text-white p-8 text-center h-screen flex items-center justify-center"><p class="text-lg"><strong>Authentication Error</strong><br><br>Anonymous sign-in failed. Please go to your Firebase Console, select your project, go to Authentication > Sign-in method, and ensure the <strong>Anonymous</strong> provider is enabled.</p></div>`;
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.body.innerHTML = `<div class="bg-red-800 text-white p-8 text-center h-screen flex items-center justify-center"><p>Error initializing application. Check console for details.</p></div>`;
            }
        }

        function initializeAppUI() {
            setupEventListeners();
            navigateTo(window.location.hash || '#dashboard');
        }

        // --- Google API Integration ---
        window.onGapiLoaded = () => {
            if (!googleIntegrationEnabled) return;
            gapi.load('client', initializeGapiClient);
        };

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: GOOGLE_API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/people/v1/rest'],
            });
            gapiInited = true;
        }

        window.onGisLoaded = () => {
            if (!googleIntegrationEnabled) return;
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_SCOPES,
                callback: '', // The callback is handled by the promise from requestAccessToken
            });
            gisInited = true;
        };
        
        function handleGoogleAuth() {
            if (!googleIntegrationEnabled) {
                 openInfoModal("Google integration is disabled. Please add your API Key and Client ID in the script to enable this feature.");
                return;
            }
            if (!gapiInited || !gisInited) {
                openInfoModal("Google API is still initializing. Please wait a moment and try again.");
                return;
            }

            if (gapi.client.getToken() === null) {
                // Prompt the user to select an account and grant access
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                // Revoke the token and clear the client's token
                gapi.client.setToken(null);
                googleSignInBtn.querySelector('span').textContent = 'Sign in with Google';
                googleAuthStatus.innerHTML = '';
            }
        }

        async function importGoogleContacts() {
            if (!googleIntegrationEnabled) {
                openInfoModal("Google integration is disabled. Please add your API Key and Client ID in the script to enable this feature.");
                return;
            }
            if (!gapiInited || !gisInited) {
                openInfoModal("Google API not initialized yet. Please try again in a moment.");
                return;
            }

            try {
                const tokenResponse = await new Promise((resolve, reject) => {
                    try {
                        tokenClient.callback = (resp) => {
                            if (resp.error) {
                                reject(new Error(resp.error));
                                return;
                            }
                            resolve(resp);
                        };
                        tokenClient.requestAccessToken({prompt: ''}); // Use empty prompt to avoid re-prompting if already signed in
                    } catch (err) {
                        reject(err);
                    }
                });

                if (tokenResponse.access_token) {
                    googleSignInBtn.querySelector('span').textContent = 'Sign Out Google';
                    googleAuthStatus.innerHTML = `<p class="text-green-400">Google Synced</p>`;

                    const response = await gapi.client.people.people.connections.list({
                        'resourceName': 'people/me',
                        'pageSize': 200, // Adjust as needed
                        'personFields': 'names,emailAddresses,phoneNumbers',
                    });

                    const connections = response.result.connections;
                    if (!connections || connections.length === 0) {
                        openInfoModal('No contacts found in your Google account.');
                        return;
                    }
                    
                    let importedCount = 0;
                    const batch = [];
                    for (const person of connections) {
                        if (person.names && person.names.length > 0) {
                            const newContact = {
                                name: person.names[0].displayName || '',
                                email: person.emailAddresses?.[0]?.value || '',
                                phone: person.phoneNumbers?.[0]?.value || '',
                                company: '', // Google Contacts doesn't have a standard company field in this basic fetch
                                createdAt: serverTimestamp()
                            };
                            
                            // Avoid adding duplicates based on email
                            if (newContact.email && !contacts.some(c => c.email === newContact.email)) {
                                batch.push(addDoc(collection(db, `artifacts/${appId}/users/${userId}/contacts`), newContact));
                                importedCount++;
                            }
                        }
                    }
                    await Promise.all(batch);
                    openInfoModal(`${importedCount} new contacts imported successfully!`);
                }
            } catch (err) {
                console.error('Error fetching/importing Google Contacts:', err);
                openInfoModal(`Could not import Google Contacts. Error: ${err.message || 'Unknown. Check console.'}`);
            }
        }


        // --- Realtime Data Fetching ---
        async function setupRealtimeListeners() {
            if (!userId) return;

            const collections = {
                contacts: collection(db, `artifacts/${appId}/users/${userId}/contacts`),
                deals: collection(db, `artifacts/${appId}/users/${userId}/deals`),
                tasks: collection(db, `artifacts/${appId}/users/${userId}/tasks`)
            };

            onSnapshot(query(collections.contacts), (snapshot) => {
                contacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentView();
            });

            onSnapshot(query(collections.deals), (snapshot) => {
                deals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentView();
            });

            onSnapshot(query(collections.tasks), (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCurrentView();
            });
        }

        // --- Rendering Logic ---
        function renderCurrentView() {
            if (!document.getElementById(`${currentView}-view`)) return;
            switch(currentView) {
                case 'dashboard': renderDashboard(); break;
                case 'contacts': renderContacts(); break;
                case 'deals': renderDeals(); break;
                case 'tasks': renderTasks(); break;
            }
        }

        function renderDashboard() {
            const openDeals = deals.filter(d => !['Closed Won', 'Closed Lost'].includes(d.stage));
            const totalRevenue = deals.filter(d => d.stage === 'Closed Won').reduce((sum, d) => sum + (Number(d.value) || 0), 0);
            const pipelineValue = openDeals.reduce((sum, d) => sum + (Number(d.value) || 0), 0);
            const upcomingTasks = tasks.filter(t => t.status !== 'Done' && new Date(t.dueDate) >= new Date()).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).slice(0, 5);

            const dashboardHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg stat-card border-blue-500">
                        <h3 class="text-gray-400 text-sm font-medium">Total Revenue</h3>
                        <p class="text-3xl font-bold text-white">$${totalRevenue.toLocaleString()}</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg stat-card border-green-500">
                        <h3 class="text-gray-400 text-sm font-medium">Pipeline Value</h3>
                        <p class="text-3xl font-bold text-white">$${pipelineValue.toLocaleString()}</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg stat-card border-purple-500">
                        <h3 class="text-gray-400 text-sm font-medium">Total Contacts</h3>
                        <p class="text-3xl font-bold text-white">${contacts.length}</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg stat-card border-yellow-500">
                        <h3 class="text-gray-400 text-sm font-medium">Open Deals</h3>
                        <p class="text-3xl font-bold text-white">${openDeals.length}</p>
                    </div>
                </div>
                <div class="mt-8 bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h3 class="text-xl font-bold mb-4">Upcoming Tasks</h3>
                    ${upcomingTasks.length > 0 ? `
                        <ul>
                            ${upcomingTasks.map(task => `
                                <li class="flex justify-between items-center p-3 border-b border-gray-700 hover:bg-gray-700 rounded-lg">
                                    <div>
                                        <p class="font-semibold">${task.title}</p>
                                        <p class="text-sm text-gray-400">Due: ${new Date(task.dueDate).toLocaleDateString()}</p>
                                    </div>
                                    <span class="text-sm font-medium px-2 py-1 rounded-full ${task.status === 'Done' ? 'bg-green-600' : 'bg-yellow-600'}">${task.status}</span>
                                </li>
                            `).join('')}
                        </ul>
                    ` : '<p class="text-gray-400">No upcoming tasks. Great job!</p>'}
                </div>
            `;
            document.getElementById('dashboard-view').innerHTML = dashboardHTML;
        }

        function renderContacts() {
            const contactsHTML = `
                <div class="text-right mb-4">
                    <button id="import-google-contacts-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg">
                        <i class="fab fa-google mr-2"></i> Import from Google Contacts
                    </button>
                </div>
                <div class="bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="p-4 font-semibold">Name</th>
                                    <th class="p-4 font-semibold">Email</th>
                                    <th class="p-4 font-semibold">Phone</th>
                                    <th class="p-4 font-semibold">Company</th>
                                    <th class="p-4 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contacts-list">
                                ${contacts.length > 0 ? contacts.map(c => `
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="p-4">${c.name || ''}</td>
                                        <td class="p-4">${c.email || ''}</td>
                                        <td class="p-4">${c.phone || ''}</td>
                                        <td class="p-4">${c.company || ''}</td>
                                        <td class="p-4">
                                            <button class="edit-btn text-blue-400 hover:text-blue-300 mr-3" data-id="${c.id}" data-type="contact"><i class="fas fa-edit"></i></button>
                                            <button class="delete-btn text-red-500 hover:text-red-400" data-id="${c.id}" data-type="contact"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                `).join('') : `<tr><td colspan="5" class="text-center p-8 text-gray-400">No contacts found. Add one to get started!</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            document.getElementById('contacts-view').innerHTML = contactsHTML;
            
            const importBtn = document.getElementById('import-google-contacts-btn');
            if (importBtn) {
                if (googleIntegrationEnabled) {
                    importBtn.addEventListener('click', importGoogleContacts);
                } else {
                    importBtn.disabled = true;
                    importBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    importBtn.title = "Google integration is disabled. Please add API keys in the code.";
                }
            }
        }

        function renderDeals() {
            const dealsHTML = `
                <div class="flex flex-col h-full">
                    <div class="flex-grow overflow-x-auto overflow-y-hidden pb-4 kanban-board">
                        <div class="flex space-x-4 min-w-max h-full">
                            ${dealStages.map(stage => `
                                <div class="bg-gray-800 rounded-lg p-4 w-72 flex-shrink-0 flex flex-col kanban-column">
                                    <h3 class="font-bold text-lg mb-4 text-center border-b-2 border-gray-600 pb-2">${stage}</h3>
                                    <div class="flex-grow space-y-3 overflow-y-auto pr-2">
                                        ${deals.filter(d => d.stage === stage).map(deal => `
                                            <div class="bg-gray-700 p-4 rounded-lg shadow-md">
                                                <h4 class="font-bold">${deal.name}</h4>
                                                <p class="text-sm text-gray-300 mt-1">$${Number(deal.value || 0).toLocaleString()}</p>
                                                <p class="text-xs text-gray-400 mt-2">${contacts.find(c => c.id === deal.contactId)?.name || 'Unknown Contact'}</p>
                                                <div class="mt-3 text-right">
                                                    <button class="edit-btn text-blue-400 hover:text-blue-300 mr-2" data-id="${deal.id}" data-type="deal"><i class="fas fa-edit"></i></button>
                                                    <button class="delete-btn text-red-500 hover:text-red-400" data-id="${deal.id}" data-type="deal"><i class="fas fa-trash"></i></button>
                                                </div>
                                            </div>
                                        `).join('') || '<p class="text-gray-500 text-sm text-center pt-4">No deals in this stage.</p>'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('deals-view').innerHTML = dealsHTML;
        }

        function renderTasks() {
            const tasksHTML = `
                <div class="bg-gray-800 rounded-xl shadow-lg">
                    <ul id="task-list">
                        ${tasks.length > 0 ? tasks.map(t => `
                            <li class="flex items-center justify-between p-4 border-b border-gray-700 hover:bg-gray-700/50">
                                <div class="flex items-center">
                                    <input type="checkbox" class="task-status-toggle form-checkbox h-5 w-5 bg-gray-900 border-gray-600 text-blue-500 rounded focus:ring-blue-500" data-id="${t.id}" ${t.status === 'Done' ? 'checked' : ''}>
                                    <div class="ml-4">
                                        <p class="font-semibold ${t.status === 'Done' ? 'line-through text-gray-500' : ''}">${t.title}</p>
                                        <p class="text-sm text-gray-400">Due: ${new Date(t.dueDate).toLocaleDateString()} | Associated with: ${contacts.find(c => c.id === t.contactId)?.name || deals.find(d => d.id === t.dealId)?.name || 'None'}</p>
                                    </div>
                                </div>
                                <div>
                                    <button class="edit-btn text-blue-400 hover:text-blue-300 mr-3" data-id="${t.id}" data-type="task"><i class="fas fa-edit"></i></button>
                                    <button class="delete-btn text-red-500 hover:text-red-400" data-id="${t.id}" data-type="task"><i class="fas fa-trash"></i></button>
                                </div>
                            </li>
                        `).join('') : '<li class="text-center p-8 text-gray-400">No tasks found. Add one to get started!</li>'}
                    </ul>
                </div>
            `;
            document.getElementById('tasks-view').innerHTML = tasksHTML;
        }

        // --- UI Interaction & Navigation ---
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(link.getAttribute('href'));
                });
            });

            // Mobile menu
            const sidebar = document.getElementById('sidebar');
            document.getElementById('menu-button').addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            // Add new button
            addNewButton.addEventListener('click', () => {
                currentEditingId = null;
                let type = currentView;
                if (type === 'dashboard') {
                    type = 'contacts';
                }
                openModal(type);
            });

            // Modal close
            modalCloseBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Google Sign In
            if (googleIntegrationEnabled) {
                googleSignInBtn.addEventListener('click', handleGoogleAuth);
            } else {
                googleSignInBtn.disabled = true;
                googleSignInBtn.classList.add('opacity-50', 'cursor-not-allowed');
                googleSignInBtn.title = "Google integration is disabled. Please add API keys in the code.";
            }


            // Dynamic event listeners for edit, delete, etc.
            document.body.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const type = editBtn.dataset.type;
                    currentEditingId = id;
                    openModal(type, findItem(type, id));
                    return;
                }

                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    const type = deleteBtn.dataset.type;
                    openConfirmationModal(`Are you sure you want to delete this ${type}?`, () => {
                        deleteItem(type, id);
                    });
                    return;
                }
            });
            
            document.body.addEventListener('change', async (e) => {
                const taskToggle = e.target.closest('.task-status-toggle');
                if (taskToggle) {
                    const id = taskToggle.dataset.id;
                    const newStatus = taskToggle.checked ? 'Done' : 'To Do';
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/tasks`, id), { status: newStatus });
                }
            });
        }
        
        function findItem(type, id) {
            switch(type) {
                case 'contact': return contacts.find(c => c.id === id);
                case 'deal': return deals.find(d => d.id === id);
                case 'task': return tasks.find(t => t.id === id);
                default: return null;
            }
        }

        function navigateTo(hash) {
            const newView = hash.substring(1);
            if (currentView === newView && document.getElementById(`${newView}-view`)?.innerHTML !== '') return;

            currentView = newView;
            window.location.hash = hash;

            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            const viewEl = document.getElementById(`${currentView}-view`);
            if(viewEl) viewEl.classList.remove('hidden');

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-blue-600'));
            document.querySelector(`.nav-link[href="${hash}"]`)?.classList.add('bg-blue-600');

            viewTitle.textContent = currentView.charAt(0).toUpperCase() + currentView.slice(1);
            
            if (currentView === 'dashboard') {
                addNewButton.querySelector('span').textContent = 'Add Contact';
            } else {
                addNewButton.querySelector('span').textContent = `Add ${getSingular(currentView)}`;
            }
            
            renderCurrentView();
        }

        function getSingular(plural) {
            if(plural === 'contacts') return 'Contact';
            if(plural === 'deals') return 'Deal';
            if(plural === 'tasks') return 'Task';
            return 'Item';
        }

        // --- Modal & Form Handling ---
        function openModal(type, data = {}) {
            let formHTML = '';
            let title = `${currentEditingId ? 'Edit' : 'Add'} ${getSingular(type)}`;

            switch(type) {
                case 'contact':
                case 'contacts':
                    formHTML = `
                        <form id="crm-form" class="space-y-4">
                            <input type="text" name="name" placeholder="Full Name" value="${data.name || ''}" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <input type="email" name="email" placeholder="Email Address" value="${data.email || ''}" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <input type="tel" name="phone" placeholder="Phone Number" value="${data.phone || ''}" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" name="company" placeholder="Company" value="${data.company || ''}" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </form>
                    `;
                    break;
                case 'deal':
                case 'deals':
                    formHTML = `
                        <form id="crm-form" class="space-y-4">
                            <input type="text" name="name" placeholder="Deal Name" value="${data.name || ''}" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <input type="number" name="value" placeholder="Deal Value ($)" value="${data.value || ''}" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select name="stage" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                ${dealStages.map(s => `<option value="${s}" ${data.stage === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                            <select name="contactId" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="">Select Associated Contact</option>
                                ${contacts.map(c => `<option value="${c.id}" ${data.contactId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                            <input type="date" name="closeDate" value="${data.closeDate || ''}" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </form>
                    `;
                    break;
                case 'task':
                case 'tasks':
                    formHTML = `
                        <form id="crm-form" class="space-y-4">
                            <input type="text" name="title" placeholder="Task Title" value="${data.title || ''}" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <input type="date" name="dueDate" value="${data.dueDate || ''}" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <select name="status" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="To Do" ${data.status === 'To Do' ? 'selected' : ''}>To Do</option>
                                <option value="Done" ${data.status === 'Done' ? 'selected' : ''}>Done</option>
                            </select>
                            <select name="contactId" class="w-full bg-gray-700 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Associate with Contact (Optional)</option>
                                ${contacts.map(c => `<option value="${c.id}" ${data.contactId === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                            </select>
                        </form>
                    `;
                    break;
            }

            modalTitle.textContent = title;
            modalContent.innerHTML = formHTML + `<button id="form-submit-btn" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">${currentEditingId ? 'Save Changes' : 'Create'}</button>`;
            
            document.getElementById('form-submit-btn').addEventListener('click', () => handleFormSubmit(getSingular(type).toLowerCase()));

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function openInfoModal(message) {
            modalTitle.textContent = 'Information';
            modalContent.innerHTML = `
                <p class="text-gray-300 mb-6">${message}</p>
                <div class="flex justify-end">
                    <button id="info-ok-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">OK</button>
                </div>
            `;
            document.getElementById('info-ok-btn').addEventListener('click', closeModal);
            showModal();
        }

        function openConfirmationModal(message, onConfirm) {
            modalTitle.textContent = 'Confirm Action';
            modalContent.innerHTML = `
                <p class="text-gray-300 mb-6">${message}</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-300">Cancel</button>
                    <button id="confirm-ok-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Delete</button>
                </div>
            `;

            const okBtn = document.getElementById('confirm-ok-btn');
            const cancelBtn = document.getElementById('confirm-cancel-btn');

            const confirmHandler = () => {
                onConfirm();
                closeModal();
                removeListeners();
            };

            const cancelHandler = () => {
                closeModal();
                removeListeners();
            };
            
            const removeListeners = () => {
                okBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            }

            okBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
            
            showModal();
        }

        function showModal() {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalBox.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal() {
            modal.classList.add('opacity-0');
            modalBox.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modalContent.innerHTML = '';
                currentEditingId = null;
            }, 300);
        }

        async function handleFormSubmit(type) {
            const form = document.getElementById('crm-form');
            if (!form || !form.checkValidity()) {
                form?.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            try {
                if (currentEditingId) {
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/${type}s`, currentEditingId), data);
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/${type}s`), data);
                }
                closeModal();
            } catch (error) {
                console.error(`Error saving ${type}:`, error);
                openInfoModal(`Failed to save ${type}. Check console for details.`);
            }
        }

        // --- Firestore CRUD Operations ---
        async function deleteItem(type, id) {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/${type}s`, id));
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                openInfoModal(`Failed to delete ${type}.`);
            }
        }

        // --- Start the app ---
        initialize();

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
